{% for course in site.data.teaching %}
    {%- if {{course.from | to_integer}} == {{include.year}} -%}
    <a>{{course.title}} ({{course.hours}})</a>
  {%- endif -%}
{% endfor %}


{% assign course_year = site.data.teaching | where: "from","2014" %}
{% for sel_course in course_year %}
  <a>{{sel_course.title}}</a>
{% endfor %}

{% assign course_inst = course_year | group_by:"institution" %}
<a>{{ course_inst | size }}</a>
{% for inst in course_inst %}
<a>{{inst.name}} {{inst.items | size }}</a>
{% endfor %}

{% comment %}Get the list of institutions{% endcomment %}
{% assign institution_list = "" %}
{% for inst in course_inst %}
{{ institution_list | append: "," }}
{{ institution_list | append: inst.name }}
{% endfor %}
<a>{{ institution_list }}</a>

{% assign institution_sep = institution_list | split: ',' %}


{% assign data_list = "" %}
{% for inst in course_inst %}
  {% if forloop.first==false %}
    {% assign data_list = data_list | append: ";" %}
  {% endif %}
  {% for course in course_year %}
    {% if course.institution == inst.name %}
      {% if forloop.first == false %}
        {% assign data_list = data_list | append: "," %}
      {% endif %}
      {% assign data_list = data_list | append: course.hours %}
    {% else %}
      {% if forloop.first == false %}
        {% assign data_list = data_list | append: "," %}
      {% endif %}
      {% assign data_list = data_list | append: "null" %}
    {% endif %}
  {% endfor %}
{% endfor %}

<a>{{ data_list }}</a>

<br><br>
{%- assign data_sep = data_list | split: ';' -%}
{% for data_line in data_sep %}
  {%- assign data_tmp = data_line | split: ',' -%}
  <a>[{% for datum in data_tmp %}{{ datum | to_integer}}{% if forloop.last %}{% else %},{% endif %}{% endfor %}]</a>
{% endfor %}




{%- assign label_list = course_year | map: 'title' -%}




<canvas id="myChart2" width="100%"></canvas>
<script>
var colors = ["#FF8F33","#26AA5A"]
var data_all = [[null, null, 81, 56],[60, 80,null,null]]
var datasets_all = ['inst1','inst2']

var chartData = {
    labels: [{% for label in label_list %}"{{ label }}"{% if forloop.last %}{% else %},{% endif %}{% endfor %}],
    datasets: datasets_all.map( i =>
        {
            backgroundColor: colors[i],
            borderColor: colors[i],
            data: data_all[i]
        })
    ]
};
var barOptions = {
scales: {
        yAxes: [{
            ticks: {
                display: false
            },
            stacked: true,
        }]
    },
  events: false,
	showTooltips: false,
	animation: {
    duration: 500,
    easing: "easeOutQuart",
    onComplete: function () {
        var ctx = this.chart.ctx;
        ctx.font = Chart.helpers.fontString(Chart.defaults.global.defaultFontFamily, 'normal', Chart.defaults.global.defaultFontFamily);
        ctx.textAlign = 'left';
        ctx.textBaseline = 'bottom';
        
        this.data.datasets.forEach(function (dataset) {
            console.log(dataset);
            for (var i = 0; i < dataset.data.length; i++) {
                var model = dataset._meta[Object.keys(dataset._meta)[0]].data[i]._model,
                    scale_max = dataset._meta[Object.keys(dataset._meta)[0]].data[i]._yScale.maxHeight;
                    left = dataset._meta[Object.keys(dataset._meta)[0]].data[i]._xScale.left;
                    offset = dataset._meta[Object.keys(dataset._meta)[0]].data[i]._xScale.longestLabelWidth;
                ctx.fillStyle = '#444';
                var y_pos = model.y - 5;
                var label = model.label;
                // Make sure data value does not get overflown and hidden
                // when the bar's value is too close to max value of scale
                // Note: The y value is reverse, it counts from top down
                if ((scale_max - model.y) / scale_max >= 0.93)
                    y_pos = model.y + 20; 
                // ctx.fillText(dataset.data[i], model.x, y_pos);
                ctx.fillText(label, left + 10, model.y + 8);
            }
        });               
    }
	}
};
var ctx = document.getElementById("myChart2").getContext("2d");
var myBar = new Chart(ctx, {
                type: 'horizontalBar',
                data: chartData,
                options: barOptions
            });
</script>
